<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Gallery - Secure Pictures</title>
    <link rel="stylesheet" href="/assets/styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <h2>üì∏ Secure Pictures</h2>
            </div>
            <div class="nav-menu">
                <a href="/" class="nav-link">Home</a>
                <a href="/gallery.html" class="nav-link active">Gallery</a>
                <a href="#" class="nav-link" onclick="logout()">Logout</a>
            </div>
        </div>
    </nav>

    <div class="gallery-header">
        <div class="container">
            <h1>üñºÔ∏è Private Photo Gallery</h1>
            <p class="welcome-message">Welcome to your secure photo collection!</p>
            <div class="auth-status">
                <span class="auth-indicator">üîí Authenticated</span>
                <span id="userInfo"></span>
            </div>
        </div>
    </div>

    <div class="gallery-container">
        <div class="container">
            <div id="galleryGrid" class="gallery-grid">
                <!-- Images will be loaded dynamically from metadata -->
                <div class="loading-message">
                    <p>üîÑ Loading your secure gallery...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Modal -->
    <div id="photoModal" class="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="close" onclick="closeModal()">&times;</span>
            <img id="modalImage" src="" alt="">
            <div class="modal-info">
                <h3 id="modalTitle"></h3>
                <p id="modalDescription"></p>
                <div class="modal-actions">
                    <button onclick="downloadImage()" class="btn btn-secondary">Download</button>
                    <button onclick="shareImage()" class="btn btn-primary">Share</button>
                </div>
            </div>
        </div>
    </div>

    <div class="protection-info">
        <div class="container">
            <div class="info-box">
                <h2>üõ°Ô∏è How Your Photos Are Protected</h2>
                <div class="protection-grid">
                    <div class="protection-item">
                        <div class="protection-icon">üîê</div>
                        <h3>Edge Authentication</h3>
                        <p>Every image request is authenticated at AWS CloudFront edge locations before delivery.</p>
                    </div>
                    <div class="protection-item">
                        <div class="protection-icon">üö´</div>
                        <h3>Direct Access Blocked</h3>
                        <p>Images cannot be accessed directly via URL without valid authentication tokens.</p>
                    </div>
                    <div class="protection-item">
                        <div class="protection-icon">‚è∞</div>
                        <h3>Session Expiry</h3>
                        <p>Authentication tokens expire automatically after 24 hours for security.</p>
                    </div>
                    <div class="protection-item">
                        <div class="protection-icon">üåç</div>
                        <h3>Global Protection</h3>
                        <p>Security is enforced at all CloudFront edge locations worldwide.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Secure Gallery</h3>
                    <p>Protected by Lambda@Edge authentication</p>
                </div>
                <div class="footer-section">
                    <h3>Security Features</h3>
                    <ul>
                        <li>Real-time authentication</li>
                        <li>Edge-based authorization</li>
                        <li>Secure token validation</li>
                        <li>Protected image delivery</li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>Actions</h3>
                    <button onclick="logout()" class="btn btn-small">Logout</button>
                </div>
            </div>
        </div>
    </footer>

    <script>
        let currentImageUrl = '';
        let currentImageTitle = '';

        // Check authentication status on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            displayUserInfo();
            loadGalleryImages();
        });

        async function loadGalleryImages() {
            try {
                // Load image metadata from S3
                const response = await fetch('/images/metadata.json');
                if (!response.ok) {
                    throw new Error('Failed to load gallery metadata');
                }
                
                const metadata = await response.json();
                const galleryGrid = document.getElementById('galleryGrid');
                
                // Clear loading message
                galleryGrid.innerHTML = '';
                
                // Create gallery items from metadata
                metadata.images.forEach((imageData, index) => {
                    const photoItem = createPhotoItem(imageData, index);
                    galleryGrid.appendChild(photoItem);
                });
                
            } catch (error) {
                console.error('Error loading gallery:', error);
                document.getElementById('galleryGrid').innerHTML = `
                    <div class="error-message">
                        <p>‚ùå Error loading gallery. Please try again later.</p>
                    </div>
                `;
            }
        }

        function createPhotoItem(imageData, index) {
            const photoItem = document.createElement('div');
            photoItem.className = 'photo-item';
            photoItem.onclick = () => openModal(imageData.url, imageData.title, imageData.description);
            
            photoItem.innerHTML = `
                <img src="${imageData.url}" alt="${imageData.title}" loading="lazy" onerror="handleImageError(this)">
                <div class="photo-overlay">
                    <h3>${imageData.title}</h3>
                    <p>${imageData.description}</p>
                </div>
            `;
            
            return photoItem;
        }

        function handleImageError(img) {
            img.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 300"><rect width="400" height="300" fill="%23f0f0f0"/><text x="200" y="150" text-anchor="middle" fill="%23666" font-family="Arial" font-size="16">Image Unavailable</text></svg>';
            img.alt = 'Image temporarily unavailable';
        }

        function checkAuthStatus() {
            const authToken = getCookie('auth_token');
            if (!authToken) {
                // Redirect to login if not authenticated
                window.location.href = '/login.html?redirect=' + encodeURIComponent(window.location.pathname);
                return;
            }
            
            // Validate token expiry (basic client-side check)
            try {
                const payload = JSON.parse(atob(authToken.split('.')[1]));
                const currentTime = Math.floor(Date.now() / 1000);
                
                if (payload.exp && currentTime > payload.exp) {
                    alert('Your session has expired. Please login again.');
                    logout();
                    return;
                }
            } catch (e) {
                console.error('Invalid token format');
                logout();
                return;
            }
        }

        function displayUserInfo() {
            const authToken = getCookie('auth_token');
            if (authToken) {
                try {
                    const payload = JSON.parse(atob(authToken.split('.')[1]));
                    const username = payload.username;
                    const expiry = new Date(payload.exp * 1000);
                    
                    document.getElementById('userInfo').innerHTML = 
                        `Logged in as: <strong>${username}</strong> | Session expires: ${expiry.toLocaleString()}`;
                } catch (e) {
                    document.getElementById('userInfo').innerHTML = 'Session info unavailable';
                }
            }
        }

        function openModal(imageSrc, title, description) {
            currentImageUrl = imageSrc;
            currentImageTitle = title;
            
            document.getElementById('modalImage').src = imageSrc;
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalDescription').textContent = description || `High-resolution view of ${title}`;
            document.getElementById('photoModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('photoModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function downloadImage() {
            // Create a temporary link to download the image
            const link = document.createElement('a');
            link.href = currentImageUrl;
            link.download = currentImageTitle.replace(/\s+/g, '-').toLowerCase() + '.jpg';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function shareImage() {
            if (navigator.share) {
                navigator.share({
                    title: currentImageTitle,
                    text: `Check out this photo: ${currentImageTitle}`,
                    url: window.location.href
                });
            } else {
                // Fallback: copy link to clipboard
                navigator.clipboard.writeText(window.location.href).then(() => {
                    alert('Gallery link copied to clipboard!');
                });
            }
        }

        function logout() {
            // Clear auth token
            document.cookie = 'auth_token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
            
            // Redirect to home page
            window.location.href = '/';
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Prevent right-click on images (basic protection)
        document.addEventListener('contextmenu', function(e) {
            if (e.target.tagName === 'IMG') {
                e.preventDefault();
                return false;
            }
        });
    </script>
</body>
</html>