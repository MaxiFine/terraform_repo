name: 'Terraform Plan'
on: 
  push:
    branches:
      - main
  # merge_group:
  #   branches:
  #     - main

  # environment:
  #   name: 'terraform-plan'
  #   url: ${{ steps.terraform.outputs.plan_url }}

  env:
    # GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    # TF_VAR_github_token: ${{ secrets.GITHUB_TOKEN }}
    # TF_VAR_github_repository: ${{ github.repository }}
    # TF_VAR_github_repository_owner: ${{ github.repository_owner }}
    AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
    AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  # CONFIG_DIRECTORY: '.github/terraform.yml'


  jobs:
    terraform-plan:
      name: 'Terraform Plan'
      runs-on: ubuntu-latest
      permissions:
        contents: read
        push: write

    env: 
      AWS_REGION: 'us-east-1'
      AWS_DEFAULT_REGION: 'us-east-1'
      AWS_S3_BUCKET: 'my-terraform-state-bucket'
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      steps:
        - name: Checkout repository
          uses: actions/checkout@v4

        - name: Set up Terraform
          uses: hashicorp/setup-terraform@v1
         
        -  name: Configure AWS Credentials
           uses: aws-actions/configure-aws-credentials@v1
           with:
              aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
              aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
              aws-region: ${{ AWS_REGION }}

        - name: Terraform Init
          run: terraform init

        - name: Terraform Plan
          id: terraform
          run: terraform plan -out=tfplan

        # - name: Upload Terraform Plan
        #   uses: actions/upload-artifact@v2
        #   with:
        #     name: tfplan