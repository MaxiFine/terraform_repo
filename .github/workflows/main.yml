name: 'Terraform Plan'
on: 
  pull_request:
    branches:
      - main
  # merge_group:
  #   branches:
  #     - main

  # environment:
  #   name: 'terraform-plan'
  #   url: ${{ steps.terraform.outputs.plan_url }}

  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    TF_VAR_github_token: ${{ secrets.GITHUB_TOKEN }}
    TF_VAR_github_repository: ${{ github.repository }}
    TF_VAR_github_repository_owner: ${{ github.repository_owner }}
    AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
    AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  CONFIG_DIRECTORY: '.github/terraform.yml'


  jobs:
    terraform-plan:
      name: 'Terraform Plan'
      runs-on: ubuntu-latest
      permissions:
        contents: read
        pull-requests: write
      steps:
        - name: Checkout repository
          uses: actions/checkout@v3

        - name: Set up Terraform
          uses: hashicorp/setup-terraform@v1
          with:
            terraform_version: 1.0.0

        - name: Terraform Init
          run: terraform init

        - name: Terraform Plan
          id: terraform
          run: terraform plan -out=tfplan

        # - name: Upload Terraform Plan
        #   uses: actions/upload-artifact@v2
        #   with:
        #     name: tfplan
